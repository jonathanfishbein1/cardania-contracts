declare var window: any
import './style.css'
import * as Lucid from 'lucid-cardano'

const supportedWallets = [
    'nami',
    'flint',
    'eternl'
]
    , getWalletApi = async namespace => {
        return await ('typhon' === namespace) ?
            window.cardano[namespace]
            :
            window.cardano[namespace].enable()
    }
    , isSupported = type => supportedWallets.includes(type)
    , hasWallet = type => isSupported(type) && window.cardano[type.toLowerCase()] !== undefined
const
    connectButton = document.getElementById('connect'),
    poolId = "pool1m3gg43uhtetn4hmw79u8836dyq8qe4cex8qnn6mks5egza7n6tp",
    bk = "testnetwIyK8IphOti170JCngH0NedP0yK8wBZs",
    connectMessage = "connect wallet",
    buyMessage = "Buy",
    buyingMessage = "Buying...",
    unbuyingMessage = "Unbuying..."
    , successMessage = "Successfully buyd to SUMN!"
    , lucid = await Lucid.Lucid.new(
        new Lucid.Blockfrost('https://cardano-testnet.blockfrost.io/api/v0', bk), 'Testnet')
if (hasWallet('nami') == true) {
    const wallet = await getWalletApi('nami') as any
    lucid.selectWallet(wallet)
    connectButton!.innerText = connectMessage
    const utils = new Lucid.Utils(lucid)
    const paymentAddressDetails = utils.getAddressDetails(await lucid.wallet.address())
    connectButton?.addEventListener('click', async () => {
        connectButton!.innerText = buyMessage
        connectButton?.addEventListener('click', async () => {
            connectButton!.innerText = buyingMessage
            const lovelaceAmount = BigInt(Number(10000000))
            const minLovelaceAmount = BigInt(Number(2000000))
            const redeemer = new Lucid.Construct(0, [])
            const serializedRedeemer = Lucid.Data.to(redeemer)
            console.log(await lucid.wallet.address())
            console.log(paymentAddressDetails)
            const scriptAddress = 'addr_test1wpvv3znd6mp3rrjh9nqa8w7whquqltzjckgxgks0rjxnj3ctetdue'
            const transaction =
                await lucid
                    .newTx()
                    .addSigner(await lucid.wallet.address())
                    .payToAddress('addr_test1vrh0kkuahtz28qpfdhsx2hm2eekf06des8h03xnm757u65sd6egwy'
                        , { lovelace: lovelaceAmount })
                    .payToContract(scriptAddress
                        , Lucid.Data.empty()
                        , { lovelace: minLovelaceAmount })
                    .attachSpendingValidator({
                        type: 'PlutusV1'
                        , script: '59107459107101000033232323232323232323232323232332232323232222322323253353330073333573466e1cd55ce9baa0064800080648c98d4cd5ce00d80c80c00b9999ab9a3370ea0089001109100091999ab9a3370ea00a9000109100111931a99ab9c01c01a0190180173333573466e1cd55cea8012400046644246600200600464646464646464646464646666ae68cdc39aab9d500a480008cccccccccc888888888848cccccccccc00402c02802402001c01801401000c008cd40548c8c8cccd5cd19b8735573aa004900011991091980080180118101aba15002301a357426ae8940088c98d4cd5ce01581481401389aab9e5001137540026ae854028cd4054058d5d0a804999aa80c3ae501735742a010666aa030eb9405cd5d0a80399a80a8101aba15006335015335502302175a6ae854014c8c8c8cccd5cd19b8735573aa00490001199109198008018011919191999ab9a3370e6aae754009200023322123300100300233502675a6ae854008c09cd5d09aba2500223263533573805e05a05805626aae7940044dd50009aba150023232323333573466e1cd55cea8012400046644246600200600466a04ceb4d5d0a80118139aba135744a004464c6a66ae700bc0b40b00ac4d55cf280089baa001357426ae8940088c98d4cd5ce01581481401389aab9e5001137540026ae854010cd4055d71aba15003335015335502375c40026ae854008c074d5d09aba2500223263533573804e04a04804626ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226aae7940044dd50009aba150023232323333573466e1d400520062321222230040053018357426aae79400c8cccd5cd19b875002480108c848888c008014c068d5d09aab9e500423333573466e1d400d20022321222230010053016357426aae7940148cccd5cd19b875004480008c848888c00c014dd71aba135573ca00c464c6a66ae7008808007c07807407006c4d55cea80089baa001357426ae8940088c98d4cd5ce00d80c80c00b880c09931a99ab9c49010350543500018017135573ca00226ea80044d55ce9baa0011232230023758002640026aa028446666aae7c004940248cd4020c010d5d080118019aba200201323232323333573466e1cd55cea801a40004666444246660020080060046464646666ae68cdc39aab9d5002480008cc8848cc00400c008c054d5d0a80119a80700a1aba135744a004464c6a66ae7006806005c0584d55cf280089baa00135742a006666aa00eeb94018d5d0a80119a8053ae357426ae8940088c98d4cd5ce00b00a00980909aba25001135573ca00226ea80044cd54005d73ad112232230023756002640026aa02444646666aae7c008940208cd401ccd54050c018d55cea80118029aab9e500230043574400602426ae840044488008488488cc00401000c488c8c8cccd5cd19b875001480008c8488c00800cc014d5d09aab9e500323333573466e1d40092002212200123263533573802402001e01c01a26aae7540044dd5000919191999ab9a3370e6aae7540092000233221233001003002300535742a0046eb4d5d09aba2500223263533573801e01a01801626aae7940044dd50009191999ab9a3370e6aae75400520002375c6ae84d55cf280111931a99ab9c00d00b00a0091375400224464646666ae68cdc3a800a40084244400246666ae68cdc3a8012400446424446006008600c6ae84d55cf280211999ab9a3370ea00690001091100111931a99ab9c01000e00d00c00b00a135573aa00226ea80048c8cccd5cd19b8750014800884880088cccd5cd19b8750024800084880048c98d4cd5ce00600500480400389aab9d3754002464646464646666ae68cdc3a800a401842444444400646666ae68cdc3a8012401442444444400846666ae68cdc3a801a40104664424444444660020120106eb8d5d0a8029bad357426ae8940148cccd5cd19b875004480188cc8848888888cc008024020dd71aba15007375c6ae84d5d1280391999ab9a3370ea00a900211991091111111980300480418061aba15009375c6ae84d5d1280491999ab9a3370ea00c900111909111111180380418069aba135573ca01646666ae68cdc3a803a400046424444444600a010601c6ae84d55cf280611931a99ab9c01401201101000f00e00d00c00b00a135573aa00826aae79400c4d55cf280109aab9e5001137540024646464646666ae68cdc3a800a4004466644424466600200a0080066eb4d5d0a8021bad35742a0066eb4d5d09aba2500323333573466e1d4009200023212230020033008357426aae7940188c98d4cd5ce00680580500480409aab9d5003135744a00226aae7940044dd5000919191999ab9a3370ea002900111909118008019bae357426aae79400c8cccd5cd19b875002480008c8488c00800cdd71aba135573ca008464c6a66ae7002802001c0180144d55cea80089baa0011122232323333573466e1cd55cea80124000466aa012600c6ae854008c014d5d09aba2500223263533573801401000e00c26aae7940044dd5000a4c24002224424660020060049210350543100112323001001223300330020020013323232323233223322323233223232323233223232323232323232323232323232332232323232323232323232222232323500553350041335335335335335325335333200150193332001500f3300800135007222200132335023335503200e335023335503200e0015024502435007222200402d135502e02d135502f49116496e636f727265637420547820746f2073656c6c6572005001235502f001235502e222533500415335003153350021001102f102f102f235502f00123353232335001235503200125335330293301e3300b003533500113263533573892103505438000360352210023355034301d00a300f00a480084d540c40c04d540c924115496e636f727265637420547820746f206275796572005335300c00113550304901094e6f207369676e657200221355031300e00350022355030001235502f3002001235502f00123355335301d0041302b4988854cd400454cd4cd540a4d40088880048cd540a8c8d400488888888894cd4ccd54c0bc4800540c88d4004894cd4ccd5cd19b8f00200f03e03d13503a0031503900221350383500122001150363011007232335502c3333333574800446666ae68cdc39aab9d5002480008cccd55cf9aab9e500323503103b2503003a2502f0382502e2502e2502e2502e03823502f03313754002426aa06200226aa0629201234572726f7220636f6e76657274696e672074784f7574446174756d20746f20756e697400221302f4988d540c00048d540bcc0080048d540bc0048cd54cd4ccc80054064ccd54c08448004d405140588ccc80054040d4004888008ccc80054028c8c8cd4094cd540d0040cd4094cd540d004000540994098ccc07800403c03d4010c8c8c8cd4098cd540d400ccd4098cd540d4008005409d409ccc0794018cd540d0c074028c03c028c038024c06c020c0740100b44d540b80b44d540bd2401134e6f206f757470757420746f20736372697074002355030001235502f300200123357380020584a66a002205a2c264646a0044444444444a66a666aa605824002a05e4a66a666ae68cdc780600081c81c09a81a8008a81a0019081c881b9a8039111000a80089a80111001099191a8011111111111199aa981389000a809281619aa98098900091a80091000999aa981389000911a801111299a800909a8021119a80110041299a999ab9a3371e00202807e07c266a06866aa08600800c01020102008a0580126a6a004446a0044444444444a66a66054014016426a002446a0024446a0064466a00446086931299a8021099aa82280100089821a4c260749311001180580091199aa980c09000a801a80e9a8011111111111199aa981109000911a8011111a8019119a8011299a999ab9a3371e026002072070266a05c00a00e200e400ea04e01224466aa601c2400246a0024466aa05a00466aa60222400246a0024466aa060004666a00246605490000009119815801000919815000a400000266012004002640026aa054442244a66a0022a03a44266a03c600800466aa600c2400200800246a002444444444400646a002444400491010023500122002122333553014120013500b500a23500122333553017120013500e500d2350012233350012330204800000488cc0840080048cc080005200000133003002001223355300712001235001223355026002333500123355300b1200123500122335502a00235500c0010012233355500801600200123355300b1200123500122335502a00235500b0010013335550030110020011112223335530101200150143355300712001235001223355026002355008001333553010120012235002225335333553017120013500a500c235001223300a0020050061003133501800400350150013355300712001235001223233550270033001005320013550292253350011355009003221350022253353300c002008112223300200a004130060030021121222300300411212223001004123350122233350032200200200135001220013200135501f2211225335001150122213350133004002335530061200100400111233001225335002101a100101711233001225335002100110180171233500e2233350032200200200135001220011225335002100115335001101510162350012222003223500122333005004002001222323230010053200135501c223350014800088d4008894cd4ccd5cd19b8f00200901b01a13007001130060033200135501b223350014800088d4008894cd4ccd5cd19b8f00200701a0191001130060032350012235002222222222253353301000a00b2135001223500122233355301412001223500222235008223500522325335335005233500425335333573466e3c0080040bc0b85400c40b880b88cd401080b894cd4ccd5cd19b8f00200102f02e15003102e133502200a0091009153350032153350022133500223350022335002233500223302400200120312335002203123302400200122203122233500420312225335333573466e1c01800c0d00cc54cd4ccd5cd19b8700500203403313302d00400110331033102c153350012102c102c501900f1326353357389201024c660002302232001355016221122253350011002221330050023335530071200100500400122333573466e3c00800404003c88cccd40049402c9402c9402c8ccd54c01048005401c8d4004894cd54cd4ccd5cd19b8f350022200235004220020130121333573466e1cd400888004d40108800404c04840484d403c00c5403800cc8004d5404c88448894cd40044d400c88004884ccd401488008c010008ccd54c01c480040140100044488008488488cc00401000c4cd4004894cd40088400c4005401048848cc00400c00888ccd5cd19b8700200100900811225335002213002001150031212230020031122001223370000400246aa00a921144e6f20636f6e74696e75696e67206f757470757400122002122001112122300200311212230010032326353357389201024c67000040031122123300100300249848004448c8c00400488cc00cc008008004cd4488cccc0092080dac4094891c641593ca39c5cbd3eb314533841d53e61ebf6ee7a0ec7c391652f31e0048811443617264616e6961466f756e64657257686974650048811ceefb5b9dbac4a380296de0655f6ace6c97e9b981eef89a7bf53dcd5200222212333300100500400300220011'
                    })
                    .payToAddress(await lucid.wallet.address(), {
                        lovelace: minLovelaceAmount
                        , '641593ca39c5cbd3eb314533841d53e61ebf6ee7a0ec7c391652f31e43617264616e6961466f756e6465725768697465': BigInt(Number(1))
                    })
                    .collectFrom([{
                        txHash: '4150f1690905c8837910cee28c3f7764f61e98a9456c2a38bc3f1f8b573ae940',
                        outputIndex: 1,
                        assets: {
                            lovelace: BigInt(Number(3000000)),
                            '641593ca39c5cbd3eb314533841d53e61ebf6ee7a0ec7c391652f31e43617264616e6961466f756e6465725768697465': BigInt(Number(1))
                        },
                        address: scriptAddress,
                        datumHash: '923918e403bf43c34b4ef6b48eb2ee04babed17320d8d1b9ff9ad086e86f44ec'
                    },], serializedRedeemer)
                    .complete()
            transaction.txComplete
            console.log(transaction)
            console.log(transaction.txComplete)
            const signedTx = await transaction
                .sign()
                .complete()
            console.log(signedTx)
            const transactionHash = await signedTx
                .submit()
            console.log(transactionHash)
            transactionHash ?
                connectButton!.innerText = successMessage
                :
                console.log('Transaction Hash', transaction)
        })
    })
}
